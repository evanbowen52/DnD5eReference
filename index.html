<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 5e Spell Finder</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.js"></script>
    <style>
        /* You can add custom styles here */
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto py-8">
        <h1 class="text-4xl font-bold mb-8 text-center">D&D 5e Spell Finder</h1>

        <!-- Search Box -->
        <form id="searchForm" class="flex justify-center mb-4">
            <input type="text" id="searchBox" placeholder="Search spells..." class="p-2 border border-gray-300 rounded-lg w-1/2" />
            <button type="submit" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Search</button>
        </form>

        <!-- Filters -->
        <div class="flex justify-center mb-4 space-x-4">
            <div>
                <h3 class="text-xl font-semibold">Filter by Class:</h3>
                <div>
                    <input type="checkbox" id="bard" value="bard" class="class-filter"> Bard
                    <input type="checkbox" id="cleric" value="cleric" class="class-filter"> Cleric
                    <input type="checkbox" id="druid" value="druid" class="class-filter"> Druid
                    <input type="checkbox" id="fighter" value="fighter" class="class-filter"> Fighter
                    <!-- Add more classes here if needed -->
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold">Filter by Level:</h3>
                <div>
                    <input type="checkbox" id="level1" value="1" class="level-filter"> Level 1
                    <input type="checkbox" id="level2" value="2" class="level-filter"> Level 2
                    <input type="checkbox" id="level3" value="3" class="level-filter"> Level 3
                    <input type="checkbox" id="level4" value="4" class="level-filter"> Level 4
                    <!-- Add more levels here if needed -->
                </div>
            </div>
        </div>

        <!-- Spell Results -->
        <div id="spellResults" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Spells will be displayed here -->
        </div>
    </div>

    <script>
        // Function to fetch spells from API
        async function fetchSpells() {
            try {
                const response = await axios.get('https://www.dnd5eapi.co/api/spells');
                return response.data.results;
            } catch (error) {
                console.error('Error fetching spells:', error);
                return [];
            }
        }

        // Function to fetch spell details
        async function fetchSpellDetails(spell) {
            try {
                const response = await axios.get(`https://www.dnd5eapi.co${spell.url}`);
                return response.data;
            } catch (error) {
                console.error('Error fetching spell details:', error);
                return null;
            }
        }

        // Function to initialize the app
        async function initializeApp() {
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '<p class="text-center text-gray-500">Loading spells...</p>';
            document.getElementById('spellResults').appendChild(loadingDiv);

            try {
                const spells = await fetchSpells();
                // Fetch details for each spell
                const spellsWithDetails = await Promise.all(
                    spells.map(async spell => {
                        const details = await fetchSpellDetails(spell);
                        return {
                            name: details.name,
                            class: details.classes?.map(c => c.name).join(', ') || 'Unknown',
                            level: details.level,
                            range: details.range,
                            casting_time: details.casting_time,
                            damage: details.damage?.damage_type?.name || '-',
                            save: details.save?.name || '-',
                            description: details.desc?.join(' ') || 'No description available'
                        };
                    })
                );

                // Store spells in localStorage for offline access
                localStorage.setItem('spells', JSON.stringify(spellsWithDetails));
                
                // Initialize with fetched spells
                initializeSpells(spellsWithDetails);
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback to cached spells if available
                const cachedSpells = JSON.parse(localStorage.getItem('spells')) || [];
                initializeSpells(cachedSpells);
            }
        }

        // Function to initialize spells
        function initializeSpells(spells) {
            window.spells = spells;
            let bookmarkedSpells = JSON.parse(localStorage.getItem('bookmarkedSpells')) || [];

            // Function to display spells
            function displaySpells(filteredSpells) {
                const spellResultsDiv = document.getElementById('spellResults');
                spellResultsDiv.innerHTML = '';

                if (filteredSpells.length === 0) {
                    spellResultsDiv.innerHTML = '<p class="text-gray-500">No spells found matching the criteria.</p>';
                    return;
                }

                filteredSpells.forEach(spell => {
                    const spellDiv = document.createElement('div');
                    spellDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-lg', 'mb-4');

                    // Create the bookmark button (if not already bookmarked)
                    const isBookmarked = bookmarkedSpells.includes(spell.name);
                    const bookmarkButton = document.createElement('button');
                    bookmarkButton.textContent = isBookmarked ? 'Remove Bookmark' : 'Bookmark';
                    bookmarkButton.classList.add('text-blue-500', 'hover:text-blue-700', 'mt-2');
                    bookmarkButton.onclick = () => toggleBookmark(spell);

                    spellDiv.innerHTML = `
                        <h4 class="font-bold text-lg">${spell.name}</h4>
                        <p><strong>Class:</strong> ${spell.class}</p>
                        <p><strong>Level:</strong> ${spell.level}</p>
                        <p><strong>Range:</strong> ${spell.range}</p>
                        <p><strong>Casting Time:</strong> ${spell.casting_time}</p>
                        <p><strong>Damage:</strong> ${spell.damage}</p>
                        <p><strong>Save:</strong> ${spell.save}</p>
                        <p><strong>Description:</strong> ${spell.description}</p>
                    `;
                    
                    spellDiv.appendChild(bookmarkButton);
                    spellResultsDiv.appendChild(spellDiv);
                });
            }

            // Function to filter spells based on selected checkboxes and search
            function filterSpells() {
                let filteredSpells = spells;

                // Get search term
                const searchTerm = document.getElementById('searchBox').value.toLowerCase();

                // Filter by search term
                if (searchTerm) {
                    filteredSpells = filteredSpells.filter(spell => 
                        spell.name.toLowerCase().includes(searchTerm) ||
                        spell.class.toLowerCase().includes(searchTerm) ||
                        spell.description.toLowerCase().includes(searchTerm)
                    );
                }

                // Get selected classes
                const selectedClasses = Array.from(document.querySelectorAll('input.class-filter:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedClasses.length > 0) {
                    filteredSpells = filteredSpells.filter(spell => 
                        spell.class.toLowerCase().includes(selectedClasses.join(','))
                    );
                }

                // Get selected levels
                const selectedLevels = Array.from(document.querySelectorAll('input.level-filter:checked'))
                    .map(checkbox => parseInt(checkbox.value));

                if (selectedLevels.length > 0) {
                    filteredSpells = filteredSpells.filter(spell => selectedLevels.includes(spell.level));
                }

                displaySpells(filteredSpells);
            }

            // Toggle bookmark status for a spell
            function toggleBookmark(spell) {
                const index = bookmarkedSpells.indexOf(spell.name);
                if (index === -1) {
                    bookmarkedSpells.push(spell.name);
                } else {
                    bookmarkedSpells.splice(index, 1);
                }

                localStorage.setItem('bookmarkedSpells', JSON.stringify(bookmarkedSpells));
                filterSpells();
            }

            // Add event listeners for checkboxes and search box
            document.querySelectorAll('input[type="checkbox"]').forEach(element => {
                element.addEventListener('change', filterSpells);
            });

            // Handle search form submission
            document.getElementById('searchForm').addEventListener('submit', (e) => {
                e.preventDefault();
                filterSpells();
            });

            // Initial display of all spells
            displaySpells(spells);
        }

        // Initialize the app
        initializeApp();
    </script>
</body>
</html>
